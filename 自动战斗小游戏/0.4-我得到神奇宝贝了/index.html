<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/js-sha256@0.9.0/build/sha256.min.js"></script>
    <title>宝可梦自走棋战斗</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        .result {
            font-size: 1.2em;
            margin-top: 20px;
        }

        input,
        button {
            margin: 10px 0;
        }

        input {
            width: 300px;
        }

        /* 全局样式 */
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        h3 {
            margin-top: 30px;
            font-size: 1.5em;
        }

        /* 表格通用样式 */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th,
        td {
            padding: 10px;
            text-align: center;
            border: 1px solid #ddd;
        }

        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        td {
            background-color: #fafafa;
        }

        /* 属性克制表样式 */
        .type-chart th {
            background-color: #ffcc00;
            color: #fff;
        }

        .type-chart td {
            background-color: #f5f5f5;
        }

        /* 宝可梦数据表样式 */
        .pokemon-table th {
            background-color: #4CAF50;
            color: #fff;
        }

        .pokemon-table td {
            background-color: #e8f5e9;
        }

        /* 强调效果 */
        .type-chart td,
        .pokemon-table td {
            font-size: 0.9em;
        }

        /* 控制容器的宽度 */
        #typeChartContainer,
        #pokemonDataContainer {
            max-width: 600px;
            margin: 0 auto;
        }

        .flex {
            display: flex;
        }

        .mr-20 {
            margin-right: 20px;
        }
    </style>
</head>

<body>
    <h1>宝可梦自走棋战斗</h1>

    <div class="flex">
        <div class="mr-20">
            <h3>预设宝可梦数据</h3>
            <div id="pokemonDataContainer"></div>

            <h3>宝可梦属性克制关系</h3>
            <div id="typeChartContainer"></div>
        </div>
        <div>
            <div class="flex">
                <div class="mr-20">
                    <h3>输入我方队伍（空格分隔）</h3>
                    <!-- <input type="text" id="playerTeamInput" placeholder="比比鸟 小火龙" /> -->
                    <input type="text" id="playerTeamInput" value="皮卡丘 比比鸟 小火龙 皮卡丘 妙蛙草" />
                </div>

                <div>
                    <h3>输入敌方队伍（空格分隔）</h3>
                    <!-- <input type="text" id="enemyTeamInput" placeholder="绿毛虫 水箭龟" /> -->
                    <input type="text" id="enemyTeamInput" value="小拉达 杰尼龟 绿毛虫 妙蛙草 小火龙" />
                </div>
            </div>

            <button onclick="startBattle()">开始战斗</button>

            <div id="battleLog"></div>
        </div>
    </div>
    <script>
        // 预设宝可梦数据
        const pokemonList = {
            '小火龙': { health: 10, attack: 6, type: '火' },
            '杰尼龟': { health: 12, attack: 5, type: '水' },
            '妙蛙草': { health: 12, attack: 5, type: '草' },
            '皮卡丘': { health: 10, attack: 5, type: '电' },
            '比比鸟': { health: 10, attack: 5, type: '飞' },
            '绿毛虫': { health: 10, attack: 5, type: '虫' },
            '小拉达': { health: 10, attack: 5, type: '普' },
        };

        // 生成预设宝可梦数据表
        function generatePokemonData() {
            let table = '<table class="pokemon-table"><thead><tr><th>宝可梦</th><th>属性</th><th>血量</th><th>攻击力</th></tr></thead><tbody>';
            for (let name in pokemonList) {
                const pokemon = pokemonList[name];
                table += `<tr><td>${name}</td><td>${pokemon.type}</td><td>${pokemon.health}</td><td>${pokemon.attack}</td></tr>`;
            }
            table += '</tbody></table>';
            document.getElementById('pokemonDataContainer').innerHTML = table;
        }

        // 宝可梦类
        class Pokemon {
            constructor(name, health, attack, type) {
                this.name = name;
                this.health = health;
                this.attack = attack;
                this.type = type;
            }

            calculateDamage(opponent) {
                // 获取属性克制关系，如果是 undefined，默认是 1
                let typeEffectiveness = (typeChart[this.type][opponent.type] !== undefined) ? typeChart[this.type][opponent.type] : 1;
                let damage = this.attack * typeEffectiveness;
                let effectivenessText = '';

                // 根据倍数确定克制关系
                if (typeEffectiveness === 0) {
                    effectivenessText = `（${this.type}对${opponent.type}无法造成伤害）`;
                } else if (typeEffectiveness > 1) {
                    effectivenessText = `（${this.type}克制${opponent.type}）`;
                } else if (typeEffectiveness < 1) {
                    effectivenessText = `（${this.type}被${opponent.type}克制）`;
                }

                return { damage, typeEffectiveness, effectivenessText };
            }
        }

        // 宝可梦属性克制关系
        const typeChart = {
            火: { 火: 1, 水: 0.5, 草: 2, 地: 0.5, 电: 1, 飞: 1, 虫: 2, 普: 1 },
            水: { 火: 2, 水: 1, 草: 0.5, 地: 2, 电: 0.5, 飞: 1, 虫: 1, 普: 1 },
            草: { 火: 0.5, 水: 2, 草: 1, 地: 2, 电: 1, 飞: 0.5, 虫: 0.5, 普: 1 },
            地: { 火: 2, 水: 0.5, 草: 0.5, 地: 1, 电: 2, 飞: 1, 虫: 1, 普: 1 },
            电: { 火: 1, 水: 2, 草: 1, 地: 0.5, 电: 1, 飞: 2, 虫: 1, 普: 1 },
            飞: { 火: 1, 水: 1, 草: 2, 地: 1, 电: 1, 飞: 1, 虫: 2, 普: 1 },
            虫: { 火: 0.5, 水: 1, 草: 2, 地: 1, 电: 1, 飞: 0.5, 虫: 1, 普: 1 },
            普: { 火: 1, 水: 1, 草: 1, 地: 1, 电: 1, 飞: 1, 虫: 1, 普: 1 }
        };

        // 生成属性克制表
        function generateTypeChart() {
            let table = '<table class="type-chart"><thead><tr><th></th>';

            // 创建表头
            Object.keys(typeChart).forEach(type => {
                table += `<th>${type}</th>`;
            });
            table += '</tr></thead><tbody>';

            // 填充表格内容
            Object.keys(typeChart).forEach(type => {
                table += `<tr><td>${type}</td>`;
                Object.keys(typeChart).forEach(otherType => {
                    let effectiveness = typeChart[type][otherType];

                    // 检查是否是0
                    if (effectiveness === undefined) {
                        effectiveness = 1;  // 如果没有值，则默认为 1
                    }

                    // 设置底色
                    let bgColor = '';
                    if (effectiveness === 2) {
                        bgColor = 'background-color: green; color: white;';
                    } else if (effectiveness === 0.5) {
                        bgColor = 'background-color: red; color: white;';
                    } else if (effectiveness === 0) {
                        bgColor = 'background-color: gray; color: white;';
                    }

                    table += `<td style="${bgColor}">${effectiveness}</td>`;
                });
                table += '</tr>';
            });

            table += '</tbody></table>';
            document.getElementById('typeChartContainer').innerHTML = table;
        }


        // 根据名字获取宝可梦对象
        function getPokemon(name) {
            let pkmnData = pokemonList[name];
            if (!pkmnData) {
                return null;
            }
            return new Pokemon(name, pkmnData.health, pkmnData.attack, pkmnData.type);
        }

        // 开始战斗
        function startBattle() {
            let playerInput = document.getElementById('playerTeamInput').value.trim();
            let enemyInput = document.getElementById('enemyTeamInput').value.trim();

            // 将玩家和敌人队伍存入本地存储
            localStorage.setItem('playerTeam', playerInput);
            localStorage.setItem('enemyTeam', enemyInput);

            let playerNames = playerInput.split(' ').map(name => name.trim());
            let enemyNames = enemyInput.split(' ').map(name => name.trim());

            // 生成队伍
            let playerTeam = playerNames.map(name => getPokemon(name)).filter(pkmn => pkmn);
            let enemyTeam = enemyNames.map(name => getPokemon(name)).filter(pkmn => pkmn);

            if (playerTeam.length === 0 || enemyTeam.length === 0) {
                alert("请输入有效的宝可梦名称！");
                return;
            }

            // 开始战斗
            battle(playerTeam, enemyTeam);
        }

        // 更新队伍状态并显示在日志中
        function updateTeamStatus(playerTeam, enemyTeam, playerIndex, enemyIndex, log) {
            log.push("<br><strong>当前队伍状态</strong>");
            log.push(`<strong>我方队伍：</strong> ${playerTeam.slice(playerIndex).map(pkmn => pkmn.name).join(' ')}`);
            log.push(`<strong>敌方队伍：</strong> ${enemyTeam.slice(enemyIndex).map(pkmn => pkmn.name).join(' ')}`);
        }

        // 战斗函数
        function battle(playerTeam, enemyTeam) {
            let battleLog = document.getElementById('battleLog');
            let log = [];
            let playerIndex = 0;
            let enemyIndex = 0;

            // 显示当前队伍状态
            updateTeamStatus(playerTeam, enemyTeam, playerIndex, enemyIndex, log);

            while (playerIndex < playerTeam.length && enemyIndex < enemyTeam.length) {
                let playerPokemon = playerTeam[playerIndex];
                let enemyPokemon = enemyTeam[enemyIndex];

                log.push(`${playerPokemon.name} 对战 ${enemyPokemon.name}`);

                // 开始战斗
                while (playerPokemon.health > 0 && enemyPokemon.health > 0) {
                    let playerResult = playerPokemon.calculateDamage(enemyPokemon);
                    let enemyResult = enemyPokemon.calculateDamage(playerPokemon);

                    let playerDamage = playerResult.damage;
                    let enemyDamage = enemyResult.damage;
                    let playerMultiplier = playerResult.typeEffectiveness;
                    let enemyMultiplier = enemyResult.typeEffectiveness;
                    let playerEffectiveness = playerResult.effectivenessText;
                    let enemyEffectiveness = enemyResult.effectivenessText;

                    // 输出伤害和克制关系
                    log.push(`${playerPokemon.name} 对 ${enemyPokemon.name} 造成了 ${playerDamage} 点伤害（伤害倍数：${playerMultiplier} ${playerEffectiveness}），${enemyPokemon.name} 剩余血量：${enemyPokemon.health - playerDamage}`);
                    log.push(`${enemyPokemon.name} 对 ${playerPokemon.name} 造成了 ${enemyDamage} 点伤害（伤害倍数：${enemyMultiplier} ${enemyEffectiveness}），${playerPokemon.name} 剩余血量：${playerPokemon.health - enemyDamage}`);

                    // 双方同时造成伤害
                    enemyPokemon.health -= playerDamage;
                    playerPokemon.health -= enemyDamage;

                    // 判断是否有宝可梦被击败
                    if (enemyPokemon.health <= 0 && playerPokemon.health <= 0) {
                        log.push("双方宝可梦同时退场！");
                        break;
                    }

                    if (enemyPokemon.health <= 0) {
                        log.push(`${enemyPokemon.name} 被击败！`);
                        break;
                    }
                    if (playerPokemon.health <= 0) {
                        log.push(`${playerPokemon.name} 被击败！`);
                        break;
                    }
                }

                // 如果敌方宝可梦被击败，换下一个宝可梦
                if (enemyPokemon.health <= 0) {
                    enemyIndex++;

                }
                // 如果我方宝可梦被击败，换下一个宝可梦
                if (playerPokemon.health <= 0) {
                    playerIndex++;
                }
                updateTeamStatus(playerTeam, enemyTeam, playerIndex, enemyIndex, log);
                // 显示每回合结果
                battleLog.innerHTML = log.join('<br>');
            }

            // 最终胜利者
            if (playerIndex >= playerTeam.length && enemyIndex >= enemyTeam.length) {
                log.push("战斗平局！");
            } else if (playerIndex >= playerTeam.length) {
                log.push("敌方训练家获胜！");
            } else {
                log.push("我方训练家获胜！");
            }

            // 记录我方和敌方队伍，以及最终结果
            log.push(`<br><strong>最终结果</strong>`)
            log.push(`<strong>我方队伍：</strong> ${playerTeam.map(pkmn => pkmn.name).join(' ')}`);
            log.push(`<strong>敌方队伍：</strong> ${enemyTeam.map(pkmn => pkmn.name).join(' ')}`);
            log.push(`<strong>战斗结果：</strong> ${playerIndex >= playerTeam.length ? '敌方训练家获胜！' : '我方训练家获胜！'}`);
            // 将战斗数据转为字符串，用于生成哈希值
            let battleData = `我方队伍：${playerTeam.map(pkmn => pkmn.name).join(' ')}\n敌方队伍：${enemyTeam.map(pkmn => pkmn.name).join(' ')}\n战斗结果：${playerIndex >= playerTeam.length ? '敌方训练家获胜！' : '我方训练家获胜！'}`;

            // 生成哈希值并附加到日志
            // let hash = sha256(battleData);
            // log.push(`<br><strong>战斗校验码：</strong> ${hash}`);

            // 最终显示日志
            battleLog.innerHTML = log.join('<br>');
        }

    </script>
    <script>
        // 页面加载时生成表格
        window.onload = function () {
            generateTypeChart();
            generatePokemonData();

            // 从本地存储读取队伍信息
            let savedPlayerTeam = localStorage.getItem('playerTeam');
            let savedEnemyTeam = localStorage.getItem('enemyTeam');

            // 如果有存储的队伍信息，填充到输入框
            if (savedPlayerTeam) {
                document.getElementById('playerTeamInput').value = savedPlayerTeam;
            }

            if (savedEnemyTeam) {
                document.getElementById('enemyTeamInput').value = savedEnemyTeam;
            }
        }
    </script>
</body>

</html>